<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Joy Division Sculpting + Smooth Explosion</title>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
        }

        .btn {
            margin: 8px;
            padding: 8px 0;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(8px);
            cursor: pointer;
            transition: background 0.2s, transform 0.15s, opacity 0.2s;
            color: white;
            font-size: 16px;
            font-weight: 300;
            width: 48px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .btn:hover {
                background: rgba(255,255,255,0.15);
                transform: scale(1.05);
            }

            .btn:active {
                transform: scale(0.95);
            }

        .active {
            background: rgba(255,255,255,0.25) !important;
        }

        canvas {
            background: #000;
            display: block;
        }
    </style>
</head>

<body>

    <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="toggleBtn" class="btn">~</button>
        <button id="plusBtn" class="btn">+</button>
        <button id="minusBtn" class="btn">−</button>

        <!-- RESET BUTTON NOW AN X -->
        <button id="resetBtn" class="btn">x</button>

        <!-- EXPLOSION BUTTON -->
        <button id="explodeBtn" class="btn">!</button>
    </div>

    <canvas id="joyCanvas" width="900" height="600"></canvas>

    <script>
        const canvas = document.getElementById("joyCanvas");
        const ctx = canvas.getContext("2d");

        const toggleBtn = document.getElementById("toggleBtn");
        const plusBtn = document.getElementById("plusBtn");
        const minusBtn = document.getElementById("minusBtn");
        const resetBtn = document.getElementById("resetBtn");
        const explodeBtn = document.getElementById("explodeBtn");

        const width = canvas.width;
        const height = canvas.height;

        const lineCount = 80;
        const pointsPerLine = 300;

        const marginTop = 40;
        const marginBottom = 40;
        const marginLeft = 40;
        const marginRight = 40;

        let mouseX = width / 2;
        let mouseY = height / 2;

        let mouseEnabled = true;
        let mode = "add";

        let isMouseDown = false;
        let lastX = null;
        let lastY = null;
        const minDistance = 10;

        const distortionField = [];
        for (let y = 0; y < height; y++) {
            distortionField[y] = new Float32Array(width);
        }

        const radius = 25;
        const strength = 0.5;
        const radiusSq = radius * radius;

        const MAX_DISTORTION = 0.5;

        // Explosion animation state
        let explosionStart = null;

        function clamp(v, min, max) {
            return v < min ? min : v > max ? max : v;
        }

        function applyGaussian(x0, y0, sign) {
            const minX = Math.max(0, x0 - radius);
            const maxX = Math.min(width - 1, x0 + radius);
            const minY = Math.max(0, y0 - radius);
            const maxY = Math.min(height - 1, y0 + radius);

            for (let y = minY; y <= maxY; y++) {
                for (let x = minX; x <= maxX; x++) {
                    const dx = x - x0;
                    const dy = y - y0;
                    const distSq = dx * dx + dy * dy;

                    if (distSq <= radiusSq) {
                        const g = Math.exp(-distSq / (radiusSq * 0.5));
                        distortionField[y][x] += sign * strength * g;
                        distortionField[y][x] = clamp(distortionField[y][x], -MAX_DISTORTION, MAX_DISTORTION);
                    }
                }
            }
        }

        plusBtn.addEventListener("click", () => {
            mode = "add";
            plusBtn.classList.add("active");
            minusBtn.classList.remove("active");
        });

        minusBtn.addEventListener("click", () => {
            mode = "subtract";
            minusBtn.classList.add("active");
            plusBtn.classList.remove("active");
        });

        plusBtn.classList.add("active");

        toggleBtn.addEventListener("click", () => {
            mouseEnabled = !mouseEnabled;
            toggleBtn.style.opacity = mouseEnabled ? "1" : "0.4";
        });

        resetBtn.addEventListener("click", () => {
            for (let y = 0; y < height; y++) {
                distortionField[y].fill(0);
            }
        });

        explodeBtn.addEventListener("click", () => {
            explosionStart = performance.now();
        });

        canvas.addEventListener("mousedown", (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor(e.clientX - rect.left);
            const y = Math.floor(e.clientY - rect.top);

            isMouseDown = true;
            lastX = x;
            lastY = y;

            if (mode === "add") applyGaussian(x, y, +1);
            else applyGaussian(x, y, -1);
        });

        canvas.addEventListener("mouseup", () => {
            isMouseDown = false;
            lastX = null;
            lastY = null;
        });

        canvas.addEventListener("mousemove", (e) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;

            if (!isMouseDown) return;

            const x = Math.floor(mouseX);
            const y = Math.floor(mouseY);

            const dx = x - lastX;
            const dy = y - lastY;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist >= minDistance) {
                if (mode === "add") applyGaussian(x, y, +1);
                else applyGaussian(x, y, -1);

                lastX = x;
                lastY = y;
            }
        });

        function smoothNoise(seed) {
            const x = Math.sin(seed * 12.9898) * 43758.5453;
            return x - Math.floor(x);
        }

        function interpolatedNoise(x) {
            const x0 = Math.floor(x);
            const x1 = x0 + 1;
            const t = x - x0;
            const n0 = smoothNoise(x0);
            const n1 = smoothNoise(x1);
            return n0 * (1 - t) + n1 * t;
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, width, height);

            const usableWidth = width - marginLeft - marginRight;
            const usableHeight = height - marginTop - marginBottom;

            for (let i = 0; i < lineCount; i++) {
                const t = i / (lineCount - 1);
                const yBase = marginTop + t * usableHeight;

                const verticalDistortion = Math.sin(t * Math.PI) * 0.2;

                ctx.beginPath();
                ctx.strokeStyle = "#fff";
                ctx.lineWidth = 1.2;

                for (let j = 0; j < pointsPerLine; j++) {
                    const xNorm = j / (pointsPerLine - 1);
                    const x = marginLeft + xNorm * usableWidth;

                    const sideFalloff = Math.sin(xNorm * Math.PI);

                    let wave =
                        Math.sin(xNorm * 8 * Math.PI * 2) * 0.4 +
                        Math.sin(xNorm * 18 * Math.PI * 2) * 0.2;

                    const noise = interpolatedNoise(j * 0.3 + i * 5.1) - 0.5;

                    let mouseInfluence = 0;
                    if (mouseEnabled) {
                        const dx = x - mouseX;
                        const dy = yBase - mouseY;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        mouseInfluence = Math.max(0, 1 - dist / 25) * 0.6;
                    }

                    const permanent = distortionField[Math.floor(yBase)][Math.floor(x)];

                    // EXPLOSION WAVE (smooth 6s build → 2s full → 6s fade)
                    let explosionWave = 0;

                    if (explosionStart !== null) {
                        const now = performance.now();
                        const elapsed = now - explosionStart;
                        const duration = 14000; // 14 seconds total

                        if (elapsed >= duration) {
                            explosionStart = null;
                        } else {
                            const tExp = elapsed / duration;

                            const centerX = width / 2;
                            const centerY = height / 2;

                            const dx = x - centerX;
                            const dy = yBase - centerY;
                            const dist = Math.sqrt(dx * dx + dy * dy);

                            const maxRadius = Math.sqrt(width * width + height * height) / 2;
                            const waveRadius = tExp * maxRadius;

                            // Envelope: 0–6s build, 6–8s full, 8–14s fade
                            let envelope;
                            if (tExp < 0.4286) envelope = tExp / 0.4286;      // 0–6s
                            else if (tExp < 0.5714) envelope = 1;             // 6–8s
                            else envelope = (1 - tExp) / 0.4286;              // 8–14s

                            // Smooth oscillation
                            const phase = dist - waveRadius;
                            const frequency = 0.075;
                            const amplitude = 1.2;

                            const oscillation = Math.sin(phase * frequency);

                            // Distance-squared falloff
                            const distanceFalloff = 1 / (1 + dist * dist * 0.00005);

                            explosionWave = oscillation * amplitude * envelope * distanceFalloff;
                        }
                    }

                    const distortion = clamp(
                        verticalDistortion * sideFalloff +
                        mouseInfluence +
                        permanent +
                        explosionWave,
                        -1.5,
                        1.5
                    );

                    wave = wave * distortion + noise * distortion * 0.8;

                    const maxDisplacement = 60;
                    const yOffset = -wave * maxDisplacement;

                    const y = yBase + yOffset;

                    if (j === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }

                ctx.stroke();
            }

            requestAnimationFrame(draw);
        }

        draw();
    </script>

</body>
</html>